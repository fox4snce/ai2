name: Proof Packet Demo
on: [push, pull_request]

jobs:
  proof:
    runs-on: ubuntu-latest
    env:
      PYTHONHASHSEED: "0"
      PP_ENGINE_URL: "http://127.0.0.1:8000"

    steps:
      # Repo A (engine, private)
      - name: Checkout engine (Repo A)
        uses: actions/checkout@v4

      # Repo B (packet, public)
      - name: Checkout Proof Packet (Repo B)
        uses: actions/checkout@v4
        with:
          repository: fox4snce/ai-organism-proof-packet   # <-- set your packet repo
          path: packet
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install engine deps (requirements optional)
        shell: bash
        run: |
            set -euo pipefail
            python -m venv .venv
            . .venv/bin/activate
            if [[ -f requirements.txt ]]; then
              pip install -r requirements.txt
            else
              echo "No requirements.txt; skipping pip install"
            fi

      - name: Seed if present & start engine (with logs)
        shell: bash
        run: |
            set -euo pipefail
            . .venv/bin/activate

            echo "pwd=$(pwd)"
            echo "Looking for seed script…"
            SEED=""
            for p in scripts/seed.py mvp/scripts/seed.py; do
              if [[ -f "$p" ]]; then SEED="$p"; break; fi
            done
            if [[ -n "$SEED" ]]; then
              echo "Running seed: $SEED"
              python "$SEED"
            else
              echo "No seed script found; continuing."
            fi

            echo "Sanity import of src.api…"
            python - <<'PY'
import importlib, sys
try:
    importlib.import_module('src.api')
    print("OK: import src.api")
except Exception as e:
    print("FAIL: import src.api ->", e)
    sys.exit(1)
PY

            # SAFE: handle unset PYTHONPATH under `set -u`
            export PYTHONPATH="${PWD}/src${PYTHONPATH:+:$PYTHONPATH}"
            echo "PYTHONPATH=$PYTHONPATH"

            echo "Starting engine via: python -m src.api"
            ( python -m src.api > server.log 2>&1 & echo $! > server.pid ) || true
            sleep 1

            # Fallback to uvicorn if it died immediately
            if ! ps -p $(cat server.pid 2>/dev/null) >/dev/null 2>&1; then
              echo "Fallback: starting via uvicorn api.server:app --app-dir src"
              ( uvicorn api.server:app --app-dir src --host 127.0.0.1 --port 8000 > server.log 2>&1 & echo $! > server.pid ) || true
              sleep 1
            fi

            if ! ps -p $(cat server.pid 2>/dev/null) >/dev/null 2>&1; then
              echo "Engine failed to launch. Last logs:"; tail -n 200 server.log || true
              exit 1
            fi

      - name: Wait for engine (healthcheck + live logs on failure)
        shell: bash
        run: |
            set -euo pipefail
            for i in $(seq 1 45); do
              if curl -sf http://127.0.0.1:8000/v1/tools >/dev/null; then
                echo "Engine ready"; exit 0
              fi
              if ! ps -p $(cat server.pid) >/dev/null 2>&1; then
                echo "Engine process died. Last logs:"; tail -n 200 server.log || true
                exit 1
              fi
              sleep 1
            done
            echo "Engine failed to become ready in time. Last logs:"; tail -n 200 server.log || true
            exit 1

      - name: Run Proof Packet
        working-directory: packet
        shell: bash
        env:
          PP_ENGINE_URL: "http://127.0.0.1:8000"
        run: |
            set -euo pipefail
            make demo
            make verify --strict
            make bench N=32
            make bench N=128
            make bundle

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: proof-packet-results
          path: |
            packet/runs/*.trace.json
            packet/artifacts/**/*.json
            packet/artifacts/proof_packet.zip
            server.log
