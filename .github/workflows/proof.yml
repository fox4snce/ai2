name: Proof Packet Demo
on: [push, pull_request]

jobs:
  proof:
    runs-on: ubuntu-latest
    env:
      # ---- config you can tweak without touching the steps ----
      PYTHONHASHSEED: "0"
      PP_ENGINE_URL: "http://127.0.0.1:8000"
      APP_DIR: "src"                     # where your Python packages live
      APP_MODULE: "mvp.api.server:app"   # <--- CHANGE THIS IF YOUR app IS ELSEWHERE

    steps:
      # Repo A (engine, private)
      - name: Checkout engine (Repo A)
        uses: actions/checkout@v4

      # Repo B (packet, public)
      - name: Checkout Proof Packet (Repo B)
        uses: actions/checkout@v4
        with:
          repository: fox4snce/ai-organism-proof-packet
          path: packet
          persist-credentials: false

      # Python toolchain
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install engine deps
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          . .venv/bin/activate
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt; skipping pip install"
          fi

      # Seed (optional) + start engine (no guessing; uses APP_MODULE/APP_DIR)
      - name: Seed if present & start engine (with logs)
        shell: bash
        run: |
          set -euo pipefail
          . .venv/bin/activate

          echo "Looking for seed scriptâ€¦"
          SEED=""
          for p in scripts/seed.py mvp/scripts/seed.py; do
            if [[ -f "$p" ]]; then SEED="$p"; break; fi
          done
          if [[ -n "$SEED" ]]; then
            echo "Running seed: $SEED"
            python "$SEED"
          else
            echo "No seed script found; continuing."
          fi

          # Safe PYTHONPATH even under 'set -u'
          export PYTHONPATH="${PWD}/${APP_DIR}${PYTHONPATH:+:$PYTHONPATH}"
          echo "PYTHONPATH=$PYTHONPATH"
          echo "Starting: uvicorn ${APP_MODULE} --app-dir ${APP_DIR}"

          # Start server; capture logs; store PID
          ( uvicorn "${APP_MODULE}" --app-dir "${APP_DIR}" --host 127.0.0.1 --port 8000 > server.log 2>&1 & echo $! > server.pid ) || true
          sleep 1
          if ! ps -p "$(cat server.pid 2>/dev/null)" >/dev/null 2>&1; then
            echo "Engine failed to launch. Last logs:"; tail -n 200 server.log || true
            exit 1
          fi

      - name: Wait for engine (healthcheck + logs on failure)
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -sf http://127.0.0.1:8000/v1/tools >/dev/null; then
              echo "Engine ready"; exit 0
            fi
            if ! ps -p "$(cat server.pid)" >/dev/null 2>&1; then
              echo "Engine died. Last logs:"; tail -n 200 server.log || true
              exit 1
            fi
            sleep 1
          done
          echo "Engine not ready in time. Last logs:"; tail -n 200 server.log || true
          exit 1

      # Run Proof Packet
      - name: Run Proof Packet
        working-directory: packet
        shell: bash
        env:
          PP_ENGINE_URL: "http://127.0.0.1:8000"
        run: |
          set -euo pipefail
          make demo
          make verify --strict
          make bench N=32
          make bench N=128
          make bundle

      # Artifacts (traces, benches, bundle, server logs)
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: proof-packet-results
          path: |
            packet/runs/*.trace.json
            packet/artifacts/**/*.json
            packet/artifacts/proof_packet.zip
            server.log
